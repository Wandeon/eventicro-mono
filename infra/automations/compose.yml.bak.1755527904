version: "3.9"

services:
  n8n:
    image: n8nio/n8n:1.60.2
    restart: unless-stopped
    # Private-by-default: bind only to loopback on the VPS
    ports:
      - "127.0.0.1:5678:5678"
    environment:
      TZ: Europe/Zagreb
      N8N_PORT: "5678"
      N8N_PROTOCOL: "http"
      N8N_HOST: "localhost"
      WEBHOOK_URL: "${N8N_WEB_URL:-}"
      # Basic auth for the UI
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: "${N8N_BASIC_AUTH_USER:?set in /srv/automations/.env}"
      N8N_BASIC_AUTH_PASSWORD: "${N8N_BASIC_AUTH_PASSWORD:?set in /srv/automations/.env}"
      # Encryption key for credentials
      N8N_ENCRYPTION_KEY: "${N8N_ENCRYPTION_KEY:?set in /srv/automations/.env}"
      # Redis (share the core network, do NOT use 127.0.0.1)
      N8N_QUEUE_BULL_REDIS_HOST: "core-redis-1"
      N8N_QUEUE_BULL_REDIS_PORT: "6379"
      N8N_QUEUE_BULL_REDIS_PASSWORD: "${REDIS_PASSWORD:?put in /srv/automations/.env}"
      # Start “regular”; we can switch to queue + workers later (as in the blueprint)
      EXECUTIONS_MODE: "regular"
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - automations
      - core_default

volumes:
  n8n-data: {}

networks:
  automations: {}
  # Reuse the existing core network so n8n can reach Redis without exposing ports
  core_default:
    external: true
